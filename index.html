<!DOCTYPE html>
<html>
  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
    <script src="js/jquery.easy-autocomplete.min.js"></script>
    <script src="js/jquery.numeric.min.js"></script>
    <link rel="stylesheet" href="css/easy-autocomplete.min.css">
   <!--[if IE 7]>
   <link rel="stylesheet" href="assets/css/font-awesome-ie7.min.css">
   <![endif]-->
   <!--[if lt IE 9]>
   <link rel="stylesheet" type="text/css" href="css/custom-theme/jquery.ui.1.10.0.ie.css"/>
   <![endif]-->
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Get London Transit Times to Destination</title>
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100%;
      }
      #progress, #shareLinkFormGroup{
        display: none;
      }
      .progress{
        margin-left:10px;
        margin-right:10px
      }
      .form-group{
        margin-left:10px;
      }
      #durationThreshold{
        width:50px;
        display:inline;
      }
      #destinationToCheck, #searchUrl{
        width:300px;
      }
      .easy-autocomplete{
        display: inline-block;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-default">
      <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Get London Commute Times</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div id="navbar" class="navbar-collapse collapse">
          <form class="navbar-form navbar-left" role="search">
            <div class="form-group">
              <label for="destinationToCheck">Destination</label>
              <input type="text" class="form-control" placeholder="Destination" id="destinationToCheck">
            </div>
            <div class="form-group">
              <label for="durationThreshold">Max Travel (mins)</label>
              <input type="test" class="form-control" value="60" id="durationThreshold">
            </div>
            <button class="btn btn-default" onclick="javascript:loadMarkers(searchDestinationCommuteTimes);return false;">Search</button>
          </form>
          <form class="navbar-form navbar-left" role="search">
            <div class="form-group" id="shareLinkFormGroup">
              <label for="searchUrl">Share Link</label>
              <input type="test" class="form-control" id="searchUrl">
            </div>
          </form>
          <ul class="nav navbar-nav navbar-right">
            <li><a href="https://github.com/Sam-Martin/get-london-commute-times">GitHub</a></li>
          </ul>
        </div><!-- /.navbar-collapse -->
      </div><!-- /.container-fluid -->
    </nav>
    <div class="row" id="progress">
        <div class="col-md-10">
          <div class="progress">
            <div class="progress-bar progress-bar-success" id="progressBar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <p id="progressText">99/100 stations found</p>
        </div>


    </div>

    <div id="map"></div>
    <script>

      var destinationToCheck = "London Eye, London"
      var apiURI = "https://9x05a3dbbk.execute-api.eu-west-1.amazonaws.com/"
      var durationThreshold = 60
      var directionsService
      var stations
      var markers = {}
      var map
      var stationsArray = []
      $(document).ready(function(){
        $('#destinationToCheck').numeric()


      })

      function getUrlVars() {
        var vars = {};
        var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
          vars[key] = value;
        });
        return vars;
      }

      var searchDestinationCommuteTimes = function(){
        destinationToCheck = $('#destinationToCheck').val();
        durationThreshold = $('#durationThreshold').val();

        // Change the destination pin colour to blue
        markers[destinationToCheck].setIcon('http://maps.google.com/mapfiles/ms/icons/blue-dot.png')

        // Set the search URL
        url = window.location.protocol + "//" +  window.location.hostname + window.location.pathname +
          "?destinationToCheck=" + encodeURIComponent(destinationToCheck) +
          "&durationThreshold=" + durationThreshold
        $('#searchUrl').val(url);
        $('#shareLinkFormGroup').css('display', 'inline');
        // Get origin durations from DynamoDB if we get
        $.getJSON(apiURI + '/dev/get-traveltimes', {destination: destinationToCheck}, function(data){

          if(typeof(data.Error) != "undefined"){
            console.log(data.Error)

            // If we haven't got the destination already, clone the stations array and iterate through it
            findStationsTravelTimes(stationsArray.slice(0),0)
          }else{
            displayStationsTravelTimes(data.Item.origins)
          }

        })
      }




      function getStationsJSON(callback){
        // Fetch the list of stations
        $.getJSON("/stations.json", function( response ) {
            stations = response

            stationsArray = []
            // generate an array of stations
            Object.keys(stations).forEach(function(stationName) {
               stationsArray.push(stationName)
            });

            $('#destinationToCheck').easyAutocomplete({
              data: stationsArray,
              list: {
            		match: {
            			enabled: true
            		}
            	}
           });
           callback();

        });
      }
      getStationsJSON(initMap)

      function displayStationsTravelTimes(stationTravelTimes){
        var unknownStationsArray = [];

        // Loop through each pre-populated station travel duration and bring it onto the map!
        for (var stationName in stations) {
          var station = stationTravelTimes[stationName]

          // We don't want to do anything with our destination pin
          if(stationName == destinationToCheck){
            continue
          }

          // Make sure it has the duration (otherwise add it to a list to be populated)
          if (stationTravelTimes.hasOwnProperty(stationName) && stationTravelTimes[stationName].hasOwnProperty("duration")) {

            // Populate the node's info window
            mapInfoWindow(station.duration + " minutes from "  + stationName + " to " + destinationToCheck, map, markers[stationName]);

            // Colour the node in accordance to our threshold
            if(station.duration < durationThreshold){
              markers[stationName].setIcon('http://maps.google.com/mapfiles/ms/icons/green-dot.png')
            }else{
              markers[stationName].setIcon('http://maps.google.com/mapfiles/ms/icons/red-dot.png')
            }
          }else{
              // add it to the unknownStationsArray if we don't know the travel duration to it
              unknownStationsArray.push(stationName)
          }
        }
        if(unknownStationsArray.length > 0){
          // Go out and find the unknown stations
          findStationsTravelTimes(unknownStationsArray, 0)
        }

      }

      function updateDynamoDB(){

        $.post(apiURI+"dev/set-traveltimes", JSON.stringify({
            destination: destinationToCheck,
            origins: stations
        }),function(response){
          console.log(response)
        }, "json" )
      }

      function findStationsTravelTimes(unknownStationsArray,index) {

        // If we've done all the stations, exit
        if(index >= unknownStationsArray.length){
          $('#progress').slideUp();
          updateDynamoDB();
          return
        }

        // Update DynamoDB with our findings every 10 results we find
        if(index > 0 && index % 10 == 0){
          updateDynamoDB();
        }

        var stationName = unknownStationsArray[index]
        var origin = stations[stationName]

        $('#progress').slideDown();
        $('#progressBar').css('width', ((index/unknownStationsArray.length)*100) + "%");
        $('#progressText').text(index + ' of ' + unknownStationsArray.length + ' stations')

        // Get the time of next monday at 9AM
        var arrivalTime = new Date();
        arrivalTime.setDate(arrivalTime.getDate() + (7-arrivalTime.getDay())%7+1)
        arrivalTime.setHours(9,0,0,0);

        // Get the duration of the trip from that source
        directionsService.route({
          origin: {lat: origin.lat,lng: origin.lng},
          destination: destinationToCheck,
          provideRouteAlternatives: true,
          travelMode: google.maps.TravelMode["TRANSIT"],
          transitOptions: {
            arrivalTime: arrivalTime
          }
        }, function(response, status) {

          var shortestRouteTime = 0;
          if (status == google.maps.DirectionsStatus.OK) {

            // Find the shortest total route time from all the legs
            response.routes.forEach(function(item, index){
              var curRouteTime = 0
              item.legs.map(function(obj){
                curRouteTime += obj.duration.value
              })
              if(shortestRouteTime == 0 || curRouteTime < shortestRouteTime){
                shortestRouteTime = curRouteTime
              }else{
              }
            })
            shortestRouteTimeMins = parseInt(shortestRouteTime/60)
            stations[stationName].duration = shortestRouteTimeMins

            // Populate the node's info window
            mapInfoWindow(shortestRouteTimeMins + " minutes from "  + stationName + " to " + destinationToCheck, map, markers[stationName])

            // Colour the node in accordance to our threshold
            if(shortestRouteTimeMins < durationThreshold){
              markers[stationName].setIcon('http://maps.google.com/mapfiles/ms/icons/green-dot.png')
            }else{
              markers[stationName].setIcon('http://maps.google.com/mapfiles/ms/icons/red-dot.png')
            }

            // Find the next station's duration in 2 seconds
            setTimeout(function(){findStationsTravelTimes(unknownStationsArray,index+1)}, 2000)
          } else {

            // Try again in 2 seconds
            console.log('Directions request failed due to ' + status);
            setTimeout(function(){findStationsTravelTimes(unknownStationsArray,index)}, 2000)
          }
        });
      }

      // Map an info window to a marker
      var mapInfoWindow = function(text, map, marker){
        var infowindow = new google.maps.InfoWindow({
          content: text
        });
        marker.addListener('click', function() {
          infowindow.open(map, marker);
        });

      }
      function populateMarkers(callback){
        Object.keys(stations).forEach(function(stationName){
          console.log("Setting marker for " + stationName)
          item = stations[stationName]
          var marker = new google.maps.Marker({
            position: {lat: item.lat, lng: item.lng},
            map: map,
            title: stationName,
            icon: 'http://maps.google.com/mapfiles/ms/icons/yellow-dot.png'
          });
          markers[stationName] = marker
        })
        callback();
      }
      function loadMarkers(callback){
        // reset the markers if they exist
        console.log("Loading markers")
        if(Object.keys(markers).length > 0){
          getStationsJSON(function(){
            console.log("We already have markers, resetting")
            Object.keys(markers).forEach(function(stationName, index){
              console.log("Resetting marker for "+ stationName)
              markers[stationName].setMap(null);
              console.log(index + " " + (markers.length -1))
              if(index == Object.keys(markers).length -1){
                markers={}
                populateMarkers(callback);
              }
            })
          });
        }else{
          markers={}
          populateMarkers(callback);
        }

        callback();
      }

      function initMap() {
        directionsService = new google.maps.DirectionsService;

        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 10,
          center: {"lat":  51.528308,
          "lng":  -0.3817765}
        });

        // If there's a querystring variable, then populate fields as appropriate
        urlVars = getUrlVars();
        if(Object.keys(urlVars).length){
          ["durationThreshold", "destinationToCheck"].forEach(function(val, index){
            if(urlVars.hasOwnProperty(val)){
              $('#'+val).val(decodeURIComponent(urlVars[val]));
            }
          })
          loadMarkers(searchDestinationCommuteTimes);
        }
      }
    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js">
    </script>
  </body>
</html>
